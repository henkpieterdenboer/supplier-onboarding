// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Users table (internal users: Admin, Inkoper, Finance, ERP)
// roles: ADMIN | INKOPER | FINANCE | ERP (multiple allowed)
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  firstName    String
  middleName   String?
  lastName     String
  roles        String[] @default([])
  labels       String[] @default(["COLORIGINZ"])
  passwordHash String?
  isActive     Boolean  @default(false)
  receiveEmails     Boolean @default(true)
  preferredLanguage String  @default("nl")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Activation
  activationToken     String?   @unique
  activationExpiresAt DateTime?

  // Relations
  createdRequests  SupplierRequest[] @relation("CreatedBy")
  uploadedFiles    SupplierFile[]
  auditLogs        AuditLog[]
}

// Main supplier onboarding requests
// status: INVITATION_SENT | AWAITING_PURCHASER | AWAITING_FINANCE | AWAITING_ERP | COMPLETED | CANCELLED
// region: EU | ROW
// incoterm: CIF | FOB
model SupplierRequest {
  id        String   @id @default(uuid())
  status    String   @default("INVITATION_SENT") // Status enum as string
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Created by (Inkoper)
  createdById String
  createdBy   User   @relation("CreatedBy", fields: [createdById], references: [id])

  // Basic info (filled by Inkoper at start)
  supplierName  String
  supplierEmail String
  region        String  // EU or ROW
  selfFill      Boolean @default(false) // If true, Inkoper fills form themselves
  supplierType     String  @default("KOOP") // KOOP, X_KWEKER, O_KWEKER
  label            String  @default("COLORIGINZ") // COLORIGINZ, PFC
  supplierLanguage String  @default("nl")  // Language for supplier form/emails

  // Supplier/Inkoper fills these fields
  companyName             String?
  address                 String?
  postalCode              String?
  city                    String?
  country                 String?
  contactName             String?
  contactPhone            String?
  contactEmail            String?
  chamberOfCommerceNumber String? // KvK nummer
  vatNumber               String? // BTW nummer
  iban                    String?
  bankName                String?
  glnNumber               String? // GLN nummer

  // Financial (Koop + O-kweker)
  invoiceEmail      String?
  invoiceAddress    String?
  invoicePostalCode String?
  invoiceCity       String?
  invoiceCurrency   String?

  // Director (Koop + O-kweker, only ROW)
  directorName           String?
  directorFunction       String?
  directorDateOfBirth    String?
  directorPassportNumber String?

  // Additional fields by Inkoper
  incoterm             String? // CIF or FOB
  commissionPercentage Float?
  paymentTerm          String? // "14" or "30"
  accountManager       String?

  // X-kweker: auction fields
  auctionNumberRFH  String?
  salesSheetEmail   String?
  mandateRFH        Boolean?
  apiKeyFloriday    String?

  // Finance fields
  creditorNumber String? @unique

  // ERP fields
  kbtCode String? @unique

  // Invitation tracking
  invitationToken     String?   @unique
  invitationExpiresAt DateTime?
  invitationSentAt    DateTime?

  // VIES VAT validation
  vatValid          Boolean?
  vatCheckResponse  String?    // JSON string of VIES response
  vatCheckedAt      DateTime?

  // Sanctions check (OpenSanctions)
  sanctionsMatch       Boolean?    // null = not checked, true = match found, false = no match
  sanctionsResponse    String?     // JSON string of sanctions check results
  sanctionsCheckedAt   DateTime?

  // Supplier submitted/saved timestamps
  supplierSubmittedAt DateTime?
  supplierSavedAt     DateTime?

  // Relations
  files     SupplierFile[]
  auditLogs AuditLog[]

  @@index([status])
  @@index([label])
  @@index([createdById])
}

// Uploaded files
// fileType: KVK | PASSPORT | OTHER
model SupplierFile {
  id         String   @id @default(uuid())
  fileName   String
  fileType   String   // KVK, PASSPORT, OTHER
  filePath   String
  uploadedAt DateTime @default(now())

  // Relations
  requestId  String
  request    SupplierRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  uploadedById String?
  uploadedBy   User?   @relation(fields: [uploadedById], references: [id])
}

// Audit trail
model AuditLog {
  id        String   @id @default(uuid())
  action    String   // e.g., "INVITATION_SENT", "SUPPLIER_SUBMITTED", "STATUS_CHANGED"
  details   String?  // JSON string with additional details
  createdAt DateTime @default(now())

  // Relations
  requestId String
  request   SupplierRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  userId    String?
  user      User?   @relation(fields: [userId], references: [id])
}
